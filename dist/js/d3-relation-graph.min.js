function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _possibleConstructorReturn(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:_assertThisInitialized(a)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _getPrototypeOf(a){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(a){return a.__proto__||Object.getPrototypeOf(a)},_getPrototypeOf(a)}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf(a,b)}function _setPrototypeOf(a,b){return _setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(a,b){return a.__proto__=b,a},_setPrototypeOf(a,b)}function _defineProperties(a,b){for(var c,e=0;e<b.length;e++)c=b[e],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(a){return typeof a}:function _typeof(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}(function(a,b){if("object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module){var c=require("d3");b(exports,c)}else"function"==typeof define&&define.amd?d3?define(["exports"],function(a){b(a,d3)}):require(["d3"],function(a){define(["exports"],function(c){b(c,a)})}):b(a.rg=a.rg||{},d3)})(this,function(a,b){function isNodeCollapsed(a,b,c,e,f){var g=[],h=!0,i=!1,j=void 0;try{for(var k,l=b[Symbol.iterator]();!(h=(k=l.next()).done);h=!0){var m=k.value,n=void 0;if(m.source===c)n=m.target;else if(m.target===c)n=m.source;else continue;e.has(n.id)||n[f]>c[f]&&g.push(m)}}catch(a){i=!0,j=a}finally{try{h||null==l.return||l.return()}finally{if(i)throw j}}for(var o,p=0;p<g.length;p++)if(o=g[p],-1===a.indexOf(o))return!0;return!1}function filterAllLowerRelation(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:[],c=2<arguments.length?arguments[2]:void 0,e=3<arguments.length?arguments[3]:void 0,f=c.links,g=c.nodes;1!==e&&(b.push(a),g.splice(g.indexOf(a),1));for(var h=[],k=0;k<f.length;k++){var l=f[k],m=void 0;if(l.source===a)m=l.target;else if(l.target===a)m=l.source;else continue;if(m)if(m.level>a.level){h.push(m),f.splice(k--,1);continue}else 1!==e&&f.splice(k--,1)}for(var n=0;n<h.length;n++)filterAllLowerRelation(h[n],b,c,e+1);if(1===e)for(var o,p=0;p<f.length;p++){o=f[p];for(var q,r=0;r<b.length;r++)if(q=b[r],(o.source===q||o.target===q)&&(-1===g.indexOf(o.source)||-1===g.indexOf(o.source))){f.splice(p--,1);break}}return b}function markRelations(a,b,c,e,f){var g=c.data()[0];if(c.classed("node")){var h=[];choseClassToEach(b,function(a){return!(a.source!==g&&a.target!==g)&&(h.push(a),!0)},e,f),choseClassToEach(a,function(a){if(g===a)return!0;for(var b,c=0;c<h.length;c++)if(b=h[c],a===b.source||a===b.target)return!0;return!1},e,f)}else{var i=c.data()[0];choseClassToEach(a,function(a){return!(a!==i.source&&a!==i.target)},e,f),choseClassToEach(b,function(a){return!(a!==g)},e,f)}}function choseClassToEach(a,c,e,f){a.each(function(a){c(a)?(b.select(this).classed(e,!0),b.select(this).classed(f,!1)):(b.select(this).classed(f,!0),b.select(this).classed(e,!1))})}function createDragHandler(a){var c=b.drag().on("start",function dragStart(c){b.event.active||a.alphaTarget(.3).restart(),c.fx=c.x,c.fy=c.y,b.select(this).attr("rg-dragging","")}).on("drag",function dragDrag(a){a.fx=b.event.x,a.fy=b.event.y}).on("end",function dragEnd(){b.event.active||a.alphaTarget(0),b.select(this).attr("rg-dragging",null)});return c}function initSimulation(a){var c=a.data,e=c.nodes,f=c.links,g=a.svg,h=parseInt(g.style("width")),i=parseInt(g.style("height")),j=b.forceLink(f).id(function(a){return a.id}).distance(200),k=b.forceSimulation().nodes(e).force("charge_force",b.forceManyBody().strength(-400)).force("center_force",b.forceCenter(h/2,i/2)).force("links",j).force("collide_force",b.forceCollide(50));return k}function removeAllClass(a,b){for(var c in a)b.classed(a[c],!1)}function findHighLevelData(a){var b=a.data,c=b.nodes,e=b.links,f=a.showLevel,g=a.levelKey,h=new o;return h.nodes=c.filter(function(a){return+a[g]<=f}),h.links=e.filter(function(a){var b=a.source[g],c=a.target[g];return+b<=f&&+c<=f}),h}function startZoom(a,c){createZoomHandler(function(){c.attr("transform",function(){var c=b.event.transform,e=c.k,f=a.attr("transform");if(!f)return c;var g=/translate\(([0-9\.]+,[0-9\.]+)\).*/,h=f.replace(g,"$1").split(",");return .1>e&&(c.k=.1,c.x=h[0],c.y=h[1]),c})})(a)}function createZoomHandler(a){return b.zoom().on("zoom",function(){a()}).filter(function(){var a=b.event.type;return"dblclick"!=a})}function findObjByKeyValueInArr(a,b,c){for(var e,f=null,g=0;g<c.length;g++)if(e=c[g],e[a]===b){f=e;break}return f}function findAllObjByKeyValueInArr(a,b,c){for(var e,f=[],g=0;g<c.length;g++)if(e=c[g],e[a]===b){f.push(e);continue}return f}var c=function DrawOptionsBaseSelf(a){_classCallCheck(this,DrawOptionsBaseSelf),this.d3Self=a},e=function DrawOptionsBaseParent(a){_classCallCheck(this,DrawOptionsBaseParent),this.d3Parent=a},f=function(){function Substance(a){_classCallCheck(this,Substance),this.drawList=a}return _createClass(Substance,[{key:"draw",value:function draw(a){var b=a.d3Self,c=!0,f=!1,h=void 0;try{for(var i,j,k=this.drawList[Symbol.iterator]();!(c=(i=k.next()).done);c=!0)if(j=i.value,j){var l=b.append("g").attr("class",j);this[j].draw(new e(l))}}catch(a){f=!0,h=a}finally{try{c||null==k.return||k.return()}finally{if(f)throw h}}}}]),Substance}(),g=function(a){function Node(a,b){var c;return _classCallCheck(this,Node),c=_possibleConstructorReturn(this,_getPrototypeOf(Node).call(this,["shape","content"])),c.shape=a,c.content=b,c}return _inherits(Node,a),_createClass(Node,[{key:"tickActions",value:function tickActions(a){var c=a.d3Self;c.attr("transform",function(a){return b.select(this),"translate("+a.x+" "+a.y+")"})}}]),Node}(f),h=function(a){function Link(a,b){var c;return _classCallCheck(this,Link),c=_possibleConstructorReturn(this,_getPrototypeOf(Link).call(this,["line","describe"])),c.line=a,c.describe=b,c}return _inherits(Link,a),_createClass(Link,[{key:"tickActions",value:function tickActions(a){var b=a.d3Self;this.line.tickActions(new e(b)),this.describe.tickActions(new e(b))}}]),Link}(f),i=function(){function LinkDescribe(a){_classCallCheck(this,LinkDescribe),this.describeContents=a}return _createClass(LinkDescribe,[{key:"draw",value:function draw(a){var b=a.d3Parent,c=b.append("g").attr("class","link-describe"),f=!0,g=!1,h=void 0;try{for(var i,j,k=this.describeContents[Symbol.iterator]();!(f=(i=k.next()).done);f=!0)j=i.value,j.draw(new e(c))}catch(a){g=!0,h=a}finally{try{f||null==k.return||k.return()}finally{if(g)throw h}}}},{key:"tickActions",value:function tickActions(a){var b=a.d3Parent;b.selectAll(".link-describe").attr("transform",function(a){return"translate("+(+a.source.x+a.target.x)/2+" "+(+a.source.y+a.target.y)/2+")"})}}]),LinkDescribe}(),j=function(){function Line(){_classCallCheck(this,Line)}return _createClass(Line,[{key:"draw",value:function draw(a){var b=a.d3Parent,c=b.append("line")}},{key:"tickActions",value:function tickActions(a){var b=a.d3Parent;b.selectAll("line").attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y})}}]),Line}(),k=function(){function Rect(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:100,b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:10,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:10;_classCallCheck(this,Rect),this.width=a,this.height=b,this.rx=c,this.ry=e}return _createClass(Rect,[{key:"draw",value:function draw(a){var b=a.d3Parent,c=this.width,e=this.height,f=this.rx,g=this.ry,h=b.append("rect").attr("width",c).attr("height",e).attr("rx",f).attr("ry",g).attr("x",-c/2).attr("y",-e/2)}}]),Rect}(),l=function(){function Circle(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:40;_classCallCheck(this,Circle),this.r=a}return _createClass(Circle,[{key:"draw",value:function draw(a){var b=a.d3Parent,c=this.r,e=b.append("circle").attr("r",c).attr("cx",0).attr("cy",0)}}]),Circle}(),m=function(){function Image(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:80,b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:80,c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"src";_classCallCheck(this,Image),this.width=a,this.height=b,this.srcKey=c}return _createClass(Image,[{key:"draw",value:function draw(a){var b=a.d3Parent,c=this.width,e=this.height,f=this.srcKey,g=b.data()[0][f],h=b.append("image").attr("x",-c/2).attr("y",-e/2).attr("width",c).attr("height",e).attr("xlink:href",g)}}]),Image}(),n=function(){function Text(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"showText",b=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:60;_classCallCheck(this,Text),this.textStrKey=a,this.isOverflowHidden=b,this.maxWidth=c}return _createClass(Text,[{key:"draw",value:function draw(a){var b=a.d3Parent,c=this.textStrKey,e=this.isOverflowHidden,f=this.maxWidth,g=b.append("text").attr("x",0).attr("y",0).text(function(a){return a[c]});e&&Text.ellipsis(g,f)}}],[{key:"ellipsis",value:function ellipsis(a,b){var c=a.text().split("");a.text("");for(var e=a.append("tspan").attr("class","ellipsis").text("..."),f=parseFloat(b-e.node().getComputedTextLength()),g=c.length,h=a.insert("tspan",":first-child").text(c.join(""));h.node().getComputedTextLength()>f&&c.length;)c.pop(),h.text(c.join(""));c.length===g&&e.remove()}}]),Text}(),o=function GraphData(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:[],b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:[];_classCallCheck(this,GraphData),this.nodes=a,this.links=b},p=function EventObj(a,b,c){_classCallCheck(this,EventObj),this.targetData=a,this.wholeData=b,this.event=c},q=function(){function Graph(a){var b=a.storeData,c=a.showData,e=a.defaultShowLevel,f=a.levelKey,g=a.typeOptions,h=a.nodeTypeKey,i=a.linkTypeKey,j=a.click,k=a.mouseover,l=a.mouseout,m=a.wrapperDom;_classCallCheck(this,Graph),this.storeData=b,this.showData=c,this.typeOptions=g,this.nodeTypeKey=h,this.linkTypeKey=i,this.click=j,this.mouseover=k,this.mouseout=l,this.svg=this.initSvg(m),this.simulation=null,this.nodesWrapper=null,this.linksWrapper=null,this.filteredIdSet=new Set,this.isSelected=!1,this.defaultShowLevel=e,this.levelKey=f}return _createClass(Graph,[{key:"init",value:function init(){var a=this.svg;this.simulation=initSimulation({data:this.showData,svg:a});var b=a.append("g").attr("class","rg");startZoom(a,b),this.linksWrapper=b.append("g").attr("class","links"),this.nodesWrapper=b.append("g").attr("class","nodes"),this.update(),this.showData=findHighLevelData({data:this.storeData,showLevel:this.defaultShowLevel,levelKey:this.levelKey}),this.update()}},{key:"initSvg",value:function initSvg(a){var c=b.select(a).append("svg").attr("class","rg-wrapper").attr("width","100%").attr("height","100%");return c}},{key:"update",value:function update(){this.updateNodesAndLinks(),this.updateEvent(),this.updateSimulation(),this.updatePosition(),this.makeNodeDraggable()}},{key:"updateNodesAndLinks",value:function updateNodesAndLinks(){this.removeSpilth(),this.enterNew()}},{key:"removeSpilth",value:function removeSpilth(){this.nodesWrapper.selectAll(".node").data(this.showData,function(a){return a.id}).exit().remove(),this.linksWrapper.selectAll(".link").data(this.showData,function(a){return a.id}).exit().remove()}},{key:"enterNew",value:function enterNew(){var a=this,e=this.nodesWrapper.selectAll(".node").data(this.showData.nodes,function(a){return a.id}).enter().append("g").attr("class",function(b){return"node ".concat(b[a.nodeTypeKey])}),f=this.typeOptions,g=this.nodeTypeKey;e.each(function(a){var e=b.select(this),h=f.nodes[a[g]];h||(h=r.nodes["default"]),h.draw(new c(e))});var h=this.linksWrapper.selectAll(".link").data(this.showData.links,function(a){return a.id}).enter().append("g").attr("class",function(b){return"link ".concat(b[a.linkTypeKey])});h.each(function(a){var e=b.select(this),h=f.links[a[g]];h||(h=r.links["default"]),h.draw(new c(e))})}},{key:"updateSimulation",value:function updateSimulation(){var a=this.showData,c=a.nodes,e=a.links,f=this.simulation,g=b.forceLink(e).id(function(a){return a.id}).distance(200);f.force("links",g),f.nodes(c)}},{key:"updatePosition",value:function updatePosition(){var a=this,b=this.showData,c=b.nodes,e=b.links,f=this.simulation;f.stop();var g=!0,h=!1,i=void 0;try{for(var j,k,l=c[Symbol.iterator]();!(g=(j=l.next()).done);g=!0)k=j.value,k.fx=null,k.fy=null}catch(a){h=!0,i=a}finally{try{g||null==l.return||l.return()}finally{if(h)throw i}}f.on("tick",function(){a.tickActions()}),f.restart()}},{key:"tickActions",value:function tickActions(){var a=this.nodesWrapper.selectAll(".node"),e=this.linksWrapper.selectAll(".link"),f=this.nodeTypeKey,g=this.linkTypeKey,h=this.typeOptions;a.each(function(a){var e=b.select(this),g=h.nodes[a[f]];g||(g=r.nodes["default"]),g.tickActions(new c(e))}),e.each(function(a){var e=b.select(this),g=h.links[a[f]];g||(g=r.links["default"]),g.tickActions(new c(e))})}},{key:"makeNodeDraggable",value:function makeNodeDraggable(){var a=createDragHandler(this.simulation);a(this.nodesWrapper.selectAll(".node"))}},{key:"updateEvent",value:function updateEvent(){var a=this,c=this.svg,e=this.click,f=this.mouseover,g=this.mouseout,h=this.showData,i=this.storeData,j=this.filteredIdSet,k=c.selectAll(".node"),l=c.selectAll(".link"),m=c.selectAll(".node, .link"),n={hoverRelating:"rg-hover-relating",hoverNotRelating:"rg-hover-not-relating",selectRelating:"rg-select-relating",selectNotRelating:"rg-select-not-relating",selectd:"rg-selected",hovered:"rg-hovered"};m.on("mouseover",function(){var c=b.select(this);a.isSelected||(c.classed(n.hovered,!0),markRelations(k,l,c,n.hoverRelating,n.hoverNotRelating)),f&&f(new p(d,a.storeData,b.event))}),m.on("mouseout",function(){a.isSelected||b.select(this).filter("[rg-dragging]").data().length||removeAllClass(n,m),g&&g(new p(d,a.storeData,b.event))}),m.on("click",function(c){a.isSelected=!0;var f=b.select(this);c.rgClickFlag?(c.rgClickFlag=!1,clearTimeout(c.rgClickTimeout),a.isSelected=!1):(c.rgClickFlag=!0,c.rgClickTimeout=setTimeout(function(){c.rgClickFlag=!1,removeAllClass(n,m),f.classed(n.selectd,!0),markRelations(k,l,f,n.selectRelating,n.selectNotRelating),e&&e(new p(c,a.storeData,b.event))},200))}),k.on("dblclick",function(b){isNodeCollapsed(h.links,i.links,b,j,a.levelKey)?a.showNextRelation(b.id):a.hideAllLowerRelation(b.id)}),c.on("click",function(){var c=b.event.target;"svg"===c.tagName&&(a.isSelected=!1,removeAllClass(n,m))})}},{key:"showNextRelation",value:function showNextRelation(a){var b=this.showData,c=this.storeData,e=this.filteredIdSet,f=findObjByKeyValueInArr("id",a,b.nodes);if(f){var g=[];c.links.forEach(function(a){var c;if(a.source===f)c=a.target;else if(a.target===f)c=a.source;else return;e.has(c.id)||-1!==b.links.indexOf(a)||(g.push(a),b.links.push(a))});var h=[];g.forEach(function(a){var c;c=a.source===f?a.target:a.source,e.has(c)?(g.splice(g.indexOf(a)),b.links.splice(b.indexOf(a))):(h.push(c),b.nodes.push(c))}),c.links.forEach(function(a){-1===b.links.indexOf(a)&&-1!==b.nodes.indexOf(a.source)&&-1!==b.nodes.indexOf(a.target)&&(g.push(a),b.links.push(a))}),(g.length||h.length)&&this.update()}}},{key:"hideAllLowerRelation",value:function hideAllLowerRelation(a){var b=this.showData,c=findObjByKeyValueInArr("id",a,b.nodes);c&&(filterAllLowerRelation(c,[],b,1),this.update())}},{key:"hideNodeById",value:function hideNodeById(a){var b=this.filteredIdSet,c=this.showData;if(!b.has(a)){var e=findObjByKeyValueInArr("id",a,c.nodes);if(e){c.nodes.splice(c.nodes.indexOf(e),1);var f=!0,g=!1,h=void 0;try{for(var i,j=c.links[Symbol.iterator]();!(f=(i=j.next()).done);f=!0){var k=i.value,l=void 0;if(k.source===e)l=k.target;else if(k.target===e)l=k.source;else continue;l.level<e.level&&c.links.splice(c.links.indexOf(k),1)}}catch(a){g=!0,h=a}finally{try{f||null==j.return||j.return()}finally{if(g)throw h}}filterAllLowerRelation(e,[e],c,1),b.add(a),this.update()}}}},{key:"hideAllNodeByKey",value:function hideAllNodeByKey(a,b){var c=findAllObjByKeyValueInArr(a,b,this.showData.nodes);if(c.length)for(var e=0;e<c.length;e++)this.hideNodeById(c[e].id)}},{key:"showNodeById",value:function showNodeById(a){var b=this.filteredIdSet,c=this.storeData;if(b.has(a)){var e=findObjByKeyValueInArr("id",a,c.nodes);e&&(this.addNodeRelation(e),this.showNextRelation(a),b.delete(a))}}},{key:"showAllNodeByKey",value:function showAllNodeByKey(a,b){var c=findAllObjByKeyValueInArr(a,b,this.storeData.nodes);if(c.length)for(var e=0;e<c.length;e++)this.showNodeById(c[e].id)}},{key:"addNodeRelation",value:function addNodeRelation(a){var b=this.showData,c=this.storeData,e=[];b.nodes.push(a);for(var k,l=0;l<c.links.length;l++)k=c.links[l],(k.source===a||k.target===a)&&e.push(k);for(var f=0;f<e.length;f++){var g=e[f],h=g.source,j=g.target;-1!==b.nodes.indexOf(h)&&-1!==b.nodes.indexOf(j)&&b.links.push(g)}this.update()}},{key:"hideAllLowerRelation",value:function hideAllLowerRelation(a){var b=this.showData,c=findObjByKeyValueInArr("id",a,b.nodes);c&&(filterAllLowerRelation(c,[],b,1),this.update())}}]),Graph}(),r={nodes:{default:new g(new l(),new n())},links:{default:new h(new j(),new i([new k,new n]))}};a.Node=g,a.Link=h,a.LinkDescribe=i,a.Line=j,a.Rect=k,a.Circle=l,a.Image=m,a.Text=n,a.Image=m,a.create=function create(a){var b=a.wrapper,c=a.defaultShowLevel,e=void 0===c?3:c,f=a.levelKey,g=void 0===f?"level":f,h=a.data,i=void 0===h?{nodes:[],links:[]}:h,j=a.typeOptions,k=a.nodeTypeKey,l=void 0===k?"type":k,m=a.linkTypeKey,n=void 0===m?"type":m,p=a.click,r=void 0===p?null:p,s=a.mouseover,t=void 0===s?null:s,u=a.mouseout,v=void 0===u?null:u;if(b="string"==typeof b?document.getElementById(b):b,!b)throw new Error("the wrapper does not exist.");var w=i.nodes,x=i.links,y=new o(_toConsumableArray(w),_toConsumableArray(x)),z=new q({wrapperDom:b,storeData:i,showData:y,typeOptions:j,nodeTypeKey:l,linkTypeKey:n,click:r,mouseover:t,mouseout:v,defaultShowLevel:e,levelKey:g});return z.init(),{hideAllNodeByKey:function hideAllNodeByKey(a,b){z.hideAllNodeByKey(a,b)},showAllNodeByKey:function showAllNodeByKey(a,b){z.showAllNodeByKey(a,b)},hideAllLowerRelation:function hideAllLowerRelation(a){z.hideAllLowerRelation(a)},showNextRelation:function showNextRelation(a){z.showNextRelation(a)}}}});
